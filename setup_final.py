
import os
import sys
import subprocess
from pathlib import Path
import shutil
import time
import signal

def kill_process_on_port(port):
    """ุฅููุงู ุงูุนูููุงุช ุงูุชู ุชุณุชุฎุฏู ุงููููุฐ ุงููุญุฏุฏ"""
    try:
        # ุงูุญุตูู ุนูู ูุนุฑู ุงูุนูููุฉ ุงูุชู ุชุณุชุฎุฏู ุงููููุฐ
        if os.name == 'posix':  # ูุธุงู Linux/Mac
            cmd = f"lsof -i :{port} -t"
            process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE)
            pid = process.stdout.read().decode().strip()
            if pid:
                print(f"๐ ุฅููุงู ุงูุนูููุฉ {pid} ุงูุชู ุชุณุชุฎุฏู ุงููููุฐ {port}...")
                os.kill(int(pid), signal.SIGTERM)
                time.sleep(1)  # ุงูุชุธุงุฑ ูุฅุบูุงู ุงูุนูููุฉ
                return True
        else:  # ูุธุงู Windows
            cmd = f"netstat -ano | findstr :{port}"
            process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE)
            output = process.stdout.read().decode()
            if output:
                # ุงุณุชุฎุฑุงุฌ ูุนุฑู ุงูุนูููุฉ ูู ุงูุฎุฑุฌ
                pid = output.strip().split()[-1]
                print(f"๐ ุฅููุงู ุงูุนูููุฉ {pid} ุงูุชู ุชุณุชุฎุฏู ุงููููุฐ {port}...")
                os.kill(int(pid), signal.SIGTERM)
                time.sleep(1)  # ุงูุชุธุงุฑ ูุฅุบูุงู ุงูุนูููุฉ
                return True
    except Exception as e:
        print(f"โ๏ธ ุชุญุฐูุฑ: ูุดู ุฅููุงู ุงูุนูููุฉ ุนูู ุงููููุฐ {port}: {e}")
    return False

def create_documents():
    """ุฅูุดุงุก ูููุงุช ุงูุฏููู ูุงูุชุนูููุงุช"""
    print("๐ ุฌุงุฑู ุฅูุดุงุก ูููุงุช ุงูุชูุซูู...")
    
    # ุฅูุดุงุก ููู ุฏููู ุงููุณุชุฎุฏู
    user_guide_path = os.path.join("dist", "ุฏููู_ูุธุงู_ุงูุฃุฑุดูุฉ.txt")
    with open(user_guide_path, "w", encoding="utf-8") as f:
        f.write("""
# ุฏููู ุงุณุชุฎุฏุงู ูุธุงู ุงูุฃุฑุดูุฉ ููุฏุฑุงุณุงุช ุงูุนููุง

## ููุฏูุฉ
ูุฐุง ุงููุธุงู ูุตูู ูุชุณููู ุนูููุฉ ุฃุฑุดูุฉ ูุฅุฏุงุฑุฉ ูุซุงุฆู ุทูุงุจ ุงูุฏุฑุงุณุงุช ุงูุนููุง.

## ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ
1. ุฅุถุงูุฉ ูุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุทูุงุจ
2. ุฃุฑุดูุฉ ูุชุตููู ุงููุซุงุฆู
3. ุงูุจุญุซ ุงููุชูุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. ุฅูุดุงุก ุชูุงุฑูุฑ ูุฅุญุตุงุฆูุงุช

## ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู
1. ูู ุจุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุงุนุชูุงุฏ ุงูููุฏูุฉ
2. ูู ููุญุฉ ุงูุชุญููุ ููููู ุงููุตูู ุฅูู ุฌููุน ูุธุงุฆู ุงููุธุงู
3. ูุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏุ ุงููุฑ ุนูู "ุฅุถุงูุฉ ุทุงูุจ" ูุฃุฏุฎู ุงูุจูุงูุงุช ุงููุทููุจุฉ
4. ูุฅุถุงูุฉ ูุซููุฉุ ุงููุฑ ุนูู "ุฅุถุงูุฉ ูุซููุฉ" ูุงุฎุชุฑ ุงูุทุงูุจ ุงููุฑุชุจุท ุจูุง
5. ููุจุญุซุ ุงุณุชุฎุฏู ุดุฑูุท ุงูุจุญุซ ูู ุงูุฃุนูู

## ุงููุณุงุนุฏุฉ ูุงูุฏุนู
ููุญุตูู ุนูู ูุณุงุนุฏุฉ ุฅุถุงููุฉุ ูุฑุฌู ุงูุชูุงุตู ูุน ูุณุคูู ุงููุธุงู.
""")
        print(f"โ ุชู ุฅูุดุงุก ุฏููู ุงููุณุชุฎุฏู ูู: {os.path.abspath(user_guide_path)}")
    
    # ุฅูุดุงุก ููู ุชุนูููุงุช ุงูุชุซุจูุช
    install_guide_path = os.path.join("dist", "ุชุนูููุงุช_ุงูุงุณุชุฎุฏุงู.txt")
    with open(install_guide_path, "w", encoding="utf-8") as f:
        f.write("""
# ุชุนูููุงุช ุชุซุจูุช ูุงุณุชุฎุฏุงู ูุธุงู ุงูุฃุฑุดูุฉ ููุฏุฑุงุณุงุช ุงูุนููุง

## ูุชุทูุจุงุช ุงููุธุงู
- ูุธุงู ุชุดุบูู: Windows 10 ุฃู ุฃุญุฏุซ / Linux / macOS
- ุฐุงูุฑุฉ ุนุดูุงุฆูุฉ: 4 ุฌูุฌุงุจุงูุช ูุญุฏ ุฃุฏูู
- ูุณุงุญุฉ ุงููุฑุต: 500 ููุฌุงุจุงูุช ูุญุฏ ุฃุฏูู

## ุฎุทูุงุช ุงูุชุซุจูุช
1. ูู ุจูู ุถุบุท ุญุฒูุฉ ุงูุจุฑูุงูุฌ ุฅูู ุงููุฌูุฏ ุงููุทููุจ
2. ูู ุจุชุดุบูู ููู "ูุธุงู_ุงูุฃุฑุดูุฉ_ุงูููุงุฆู.exe"
3. ุณูุชู ูุชุญ ุงููุชุตูุญ ุชููุงุฆููุง ูุนุฑุถ ูุงุฌูุฉ ุงูููุจ ุงูุฎุงุตุฉ ุจุงููุธุงู

## ุจุฏุก ุงูุงุณุชุฎุฏุงู
1. ุงุณุชุฎุฏู ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ุงูุงูุชุฑุงุถูุฉ:
   - ุงุณู ุงููุณุชุฎุฏู: admin
   - ูููุฉ ุงููุฑูุฑ: admin
2. ูู ุจุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุงูุงูุชุฑุงุถูุฉ ูู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
3. ุงุจุฏุฃ ุจุงุณุชุฎุฏุงู ุงููุธุงู!

## ููุงุญุธุงุช ูุงูุฉ
- ูุชู ุญูุธ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชููุงุฆููุง ูู ูุฌูุฏ ุงูุชุทุจูู
- ูู ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุดูู ุฏูุฑู
- ูู ุญุงูุฉ ูุณูุงู ูููุฉ ุงููุฑูุฑุ ูููู ุฅุนุงุฏุฉ ุชุนููููุง ุนู ุทุฑูู ุญุฐู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุจุฑูุงูุฌ
""")
        print(f"โ ุชู ุฅูุดุงุก ุชุนูููุงุช ุงูุงุณุชุฎุฏุงู ูู: {os.path.abspath(install_guide_path)}")

def create_final_package():
    """ุชุฌููุน ุงููููุงุช ูู ุญุฒูุฉ ูุงุญุฏุฉ"""
    print("๐ฆ ุฌุงุฑู ุฅูุดุงุก ุงูุญุฒูุฉ ุงูููุงุฆูุฉ...")
    
    # ุฅูุดุงุก ูุฌูุฏ ุงูุญุฒูุฉ ุงูููุงุฆูุฉ
    final_dir = os.path.join("dist", "ูุธุงู_ุงูุฃุฑุดูุฉ_ุงูููุงุฆู")
    os.makedirs(final_dir, exist_ok=True)
    
    # ูุณุฎ ุงููููุงุช ุงูุถุฑูุฑูุฉ
    try:
        # ูุณุฎ ูููุงุช ุงูุชูุซูู
        shutil.copy2(os.path.join("dist", "ุชุนูููุงุช_ุงูุงุณุชุฎุฏุงู.txt"), final_dir)
        shutil.copy2(os.path.join("dist", "ุฏููู_ูุธุงู_ุงูุฃุฑุดูุฉ.txt"), final_dir)
        
        # ูุณุฎ ุงููููุงุช ุงูุถุฑูุฑูุฉ ููุชุดุบูู
        print("๐ ุฌุงุฑู ูุณุฎ ูููุงุช ุงููุธุงู...")
        shutil.copy2("main.py", final_dir)
        
        # ุฅูุดุงุก ูุฌูุฏุงุช ุงููุธุงู
        os.makedirs(os.path.join(final_dir, "templates"), exist_ok=True)
        os.makedirs(os.path.join(final_dir, "static"), exist_ok=True)
        os.makedirs(os.path.join(final_dir, "database"), exist_ok=True)
        
        # ูุณุฎ ูุญุชููุงุช ุงููุฌูุฏุงุช
        for item in os.listdir("templates"):
            src = os.path.join("templates", item)
            dst = os.path.join(final_dir, "templates", item)
            if os.path.isfile(src):
                shutil.copy2(src, dst)
        
        for item in os.listdir("static"):
            src = os.path.join("static", item)
            dst = os.path.join(final_dir, "static", item)
            if os.path.isdir(src):
                shutil.copytree(src, dst, dirs_exist_ok=True)
            elif os.path.isfile(src):
                shutil.copy2(src, dst)
        
        for item in os.listdir("database"):
            src = os.path.join("database", item)
            dst = os.path.join(final_dir, "database", item)
            if os.path.isfile(src):
                shutil.copy2(src, dst)
        
        # ูุณุฎ ูููุงุช ุงููุธุงู ุงูุฃุฎุฑู
        for file in ["models.py", "forms.py", "fix_database.py", "config.py"]:
            if os.path.exists(file):
                shutil.copy2(file, final_dir)
        
        # ุฅูุดุงุก ููู ุชุดุบูู ูููุธุงู
        starter_script = os.path.join(final_dir, "ุชุดุบูู_ูุธุงู_ุงูุฃุฑุดูุฉ.bat")
        with open(starter_script, "w", encoding="utf-8") as f:
            f.write("""@echo off
echo ุชุดุบูู ูุธุงู ุงูุฃุฑุดูุฉ ููุฏุฑุงุณุงุช ุงูุนููุง...
python main.py
pause
""")
        
        print(f"โ ุชู ุฅูุดุงุก ุญุฒูุฉ ุงููุธุงู ุจูุฌุงุญ ูู: {os.path.abspath(final_dir)}")
        return True
    except Exception as e:
        print(f"โ ูุดู ุฅูุดุงุก ุงูุญุฒูุฉ ุงูููุงุฆูุฉ: {e}")
        return False

if __name__ == "__main__":
    print("==== ุจุฏุก ุนูููุฉ ุฅูุดุงุก ููู ุงูุชูุตูุจ ====")

    # ุฅููุงู ุฃู ุนูููุงุช ุชุณุชุฎุฏู ุงููููุฐ 8080
    kill_process_on_port(8080)

    try:
        # ุฅูุดุงุก ูููุงุช ุงูุชูุซูู
        create_documents()
        
        # ุฅูุดุงุก ุงูุญุฒูุฉ ุงูููุงุฆูุฉ
        create_final_package()
        
        print("\nโโโ ุชู ุงูุชูุงู ุงูุนูู ุจูุฌุงุญ! โโโ")
        print(f"ููููู ุงูุนุซูุฑ ุนูู ููู ุงููุธุงู ูู: {os.path.abspath(os.path.join('dist', 'ูุธุงู_ุงูุฃุฑุดูุฉ_ุงูููุงุฆู'))}")
        print("\nููููู ุงูุขู ุชุดุบูู ุงููุธุงู ูู ุฎูุงู ูุงุฌูุฉ ุงูููุจ ุนูู ุงูุนููุงู:")
        print("http://127.0.0.1:8080\n")
        print("ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู:")
        print("ุงุณู ุงููุณุชุฎุฏู: admin")
        print("ูููุฉ ุงููุฑูุฑ: admin")
    except Exception as e:
        print(f"\nโ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน: {e}")

    print("\nุงุถุบุท Enter ููุฎุฑูุฌ...")
    input()
